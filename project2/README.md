# 基于数字水印的图片泄露检测

---

## 一、项目概述

本项目基于 **离散小波变换（DWT）** 实现数字水印的嵌入与提取功能，并通过鲁棒性测试验证水印在常见图像操作（如翻转、平移、裁剪、对比度调整）后的抗攻击能力。该系统可用于检测图片是否被非法复制或篡改，适用于版权保护、内容溯源等场景。

---

## 二、核心模块说明

### 1. 水印嵌入（`embed_watermark`）

#### **流程步骤**

1. **图像预处理**

   - 将原始图像和水印图像转换为灰度图像。
   - 对水印进行二值化处理（0 和 255），确保水印信息清晰。
   - 将水印图像缩放至原始图像的 1/4 大小，降低对视觉的干扰。

2. **小波变换**

   - 使用 Haar 小波对原始图像进行二维离散小波分解（DWT），得到四个子带：
     - **LL（低频-低频）**：保留图像主体信息。
     - **LH（低频-高频）**、**HL（高频-低频）**、**HH（高频-高频）**：包含图像边缘和纹理细节。
   - **嵌入位置选择**：将水印嵌入到 **LL 子带**。
   - **嵌入公式**：
     $$
     LL_{\text{modified}} = LL + \alpha \times \text{watermark}
     $$
     其中 `alpha` 控制水印强度（越大越明显，但越容易被攻击破坏）。

3. **图像重构**
   - 将修改后的子带与未修改的子带组合，通过逆小波变换（IDWT）重构水印图像。
   - 保存输出图像为 `output_path`。

#### **关键参数**

- `alpha`：水印强度系数（默认 0.1，范围 0.01~0.5）。
- **水印尺寸**：原始图像的 1/4 大小（可调整比例适应不同需求）。

---

### 2. 水印提取（`extract_watermark`）

#### **流程步骤**

1. **图像预处理**

   - 加载嵌入水印的图像，并对原始水印进行二值化和缩放处理。

2. **小波分解**

   - 对嵌入水印的图像进行 DWT 分解，获取修改后的 LL 子带。

3. **水印提取**

   - 从 LL 子带中提取水印区域，并减去相邻区域的平均值以消除图像背景噪声。
   - **归一化处理**：
     $$
     \text{extracted\_watermark} = \frac{\text{LL}_{\text{modified}}}{\alpha}
     $$

4. **输出结果**
   - 返回提取出的水印图像（8 位灰度格式）。

---

### 3. 鲁棒性测试（`robustness_test`）

#### **支持的攻击类型**

| 攻击类型    | 说明                             |
| ----------- | -------------------------------- |
| `flip`      | 水平翻转图像                     |
| `translate` | 向右下平移 50 像素               |
| `crop`      | 裁剪中间区域（去除边缘 50 像素） |
| `contrast`  | 对比度增强（alpha=1.5）          |

#### **评估指标**

- **PSNR（峰值信噪比）**：衡量提取水印与原始水印的均方误差（MSE），值越大表示失真越小。
  $$
  \text{PSNR} = 20 \log_{10} \left( \frac{255}{\sqrt{\text{MSE}}} \right)
  $$
- **SSIM（结构相似性指数）**：衡量提取水印与原始水印的结构相似性，值范围 [0,1]，越接近 1 表示越相似。

#### **测试流程**

1. 对嵌入水印的图像应用指定攻击。
2. 提取攻击后的水印。
3. 计算 PSNR 和 SSIM 指标。
4. 返回所有攻击类型的测试结果。

#### 示例用法

```py
# 嵌入水印
embed_watermark("original.jpg", "watermark.png", "watermarked.jpg")

# 提取水印
extracted = extract_watermark("watermarked.jpg", "watermark.png")
cv2.imwrite("extracted.png", extracted)

# 鲁棒性测试
results = robustness_test("watermarked.jpg", "watermark.png", ["flip", "translate"])
print(results)
```
